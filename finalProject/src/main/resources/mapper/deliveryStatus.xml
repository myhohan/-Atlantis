<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kh.finalproject.mapper.DeliveryStatusMapper">

    <sql id="searchCondition">
        <if test="status != null and status != '' and status != 'all'">
            AND TRANSPORT_STATUS = #{status}
        </if>
        
        <if test="query != null and query != ''">
            <bind name="pattern" value="'%' + query.trim() + '%'" />
            AND (
                TO_CHAR(POST_NO) LIKE #{pattern}
                OR SENDER_NAME LIKE #{pattern}
                OR RECEPIENT_NAME LIKE #{pattern}
            )
        </if>
    </sql>

    <select id="getListCount" parameterType="map" resultType="_int">
        SELECT COUNT(*) 
        FROM POSTAL_ITEM
        WHERE MEMBER_DEL_FL = 'N'
        <include refid="searchCondition"/> 
    </select>

    <select id="selectDeliveryList" parameterType="map" resultType="com.kh.finalproject.dto.DeliveryStatus">
        SELECT 
            POST_NO              AS "postNo",
            SENDER_NAME          AS "senderName",
            
            RECEPIENT_NAME       AS "recipientName",
            RECEPIENT_ADDRESS    AS "recipientAddress",
            RECEPIENT_PHONE      AS "recipientPhone",
            
            TRANSPORT_STATUS     AS "transportStatus",
            TO_CHAR(REG_DATE, 'YYYY-MM-DD') AS "regDate"
        FROM POSTAL_ITEM
        WHERE MEMBER_DEL_FL = 'N'
        <include refid="searchCondition"/> 
        ORDER BY REG_DATE DESC
        
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>
    
    <select id="getDeliveryStatusCounts" resultType="map">
    SELECT 
        TRANSPORT_STATUS AS "transportStatus", -- 리액트 entry.transportStatus와 일치시킴
        COUNT(*)         AS "totalCount"      -- 리액트 dataKey="totalCount"와 일치시킴
    FROM POSTAL_ITEM                          -- 테이블명 확인 (DELIVERY_STATUS 아님)
    WHERE MEMBER_DEL_FL = 'N'                 -- 삭제되지 않은 것만 집계
    GROUP BY TRANSPORT_STATUS
</select>

</mapper>