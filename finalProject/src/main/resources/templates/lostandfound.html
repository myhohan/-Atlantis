<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>분실 및 추적 - LogiSystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a th:href="@{/}" class="flex items-center gap-2">
                        <div class="bg-blue-600 p-2 rounded-lg text-white">
                            <i data-lucide="package" class="w-6 h-6"></i>
                        </div>
                        <span class="text-xl font-bold text-gray-900">택배시스템</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                     <th:block th:if="${session.loginMember != null}">
                        <span class="text-gray-700 font-bold">
                            <span th:text="${session.loginMember.memberNickname}">사용자</span>님
                        </span>
                        <a th:href="@{/member/logout}" class="text-sm text-gray-500 hover:text-red-600">로그아웃</a>
                    </th:block>
                    <th:block th:if="${session.loginMember == null}">
                        <a th:href="@{/member/login}" class="text-gray-500 hover:text-blue-600 font-medium">로그인</a>
                    </th:block>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8 flex-grow">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">분실 및 추적</h1>
            <p class="text-gray-600">분실된 택배를 신고하고 처리 현황을 확인하세요.</p>
			<a href="/" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors shadow-sm">
			        <i data-lucide="home" class="w-5 h-5"></i>
			        <span class="font-medium">return</span>
			    </a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
                <div class="bg-blue-500 w-12 h-12 rounded-lg flex items-center justify-center mb-4">
                    <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="stat-total">-</div>
                <div class="text-sm text-gray-600">전체 신고</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
                <div class="bg-yellow-500 w-12 h-12 rounded-lg flex items-center justify-center mb-4">
                    <i data-lucide="search" class="w-6 h-6 text-white"></i>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="stat-investigation">-</div>
                <div class="text-sm text-gray-600">조사중</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-100">
                <div class="bg-green-500 w-12 h-12 rounded-lg flex items-center justify-center mb-4">
                    <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="stat-discover">-</div>
                <div class="text-sm text-gray-600">발견 및 처리완료</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                <i data-lucide="edit-3" class="w-5 h-5"></i> 분실 신고 접수
            </h2>
            
            <form id="lossForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">송장번호</label>
                        <input type="text" name="postNo" placeholder="예: 1234567890" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">분실 유형</label>
                        <select name="lossType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <option value="lost">분실 (물건이 없어짐)</option>
                            <option value="damaged">파손 (물건이 망가짐)</option>
                            <option value="delay">배송 지연</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">상세 설명</label>
                        <textarea name="requestExplanation" rows="5" placeholder="발생한 상황을 자세히 적어주세요." required 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="reset" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">초기화</button>
                    <button type="submit" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md transition">신고 접수</button>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">
            <div class="px-6 py-4 border-b bg-gray-50">
                <h3 class="text-lg font-bold text-gray-800">최근 신고 내역</h3>
            </div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">송장번호</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">유형</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">신고일</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="reportListBody">
                    <tr>
                        <td class="px-6 py-10 text-center text-gray-500" colspan="4">
                            <div class="flex flex-col items-center">
                                <i data-lucide="inbox" class="w-8 h-8 mb-2 text-gray-300"></i>
                                데이터 로딩중...
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 아이콘 실행
        lucide.createIcons();

        // [기능 1] 통계 데이터 로드 함수
        function loadStatistics() {
            fetch('/api/lostandfound/totalReport')
                .then(res => res.json())
                .then(data => { document.getElementById('stat-total').innerText = data; })
                .catch(() => document.getElementById('stat-total').innerText = '0');

            fetch('/api/lostandfound/totalInvestigation')
                .then(res => res.json())
                .then(data => { document.getElementById('stat-investigation').innerText = data; })
                .catch(() => document.getElementById('stat-investigation').innerText = '0');
                
            fetch('/api/lostandfound/totalDiscover')
                .then(res => res.json())
                .then(data => { document.getElementById('stat-discover').innerText = data; })
                .catch(() => document.getElementById('stat-discover').innerText = '0');
        }

        // [기능 2] 신고 내역 목록 로드 함수 (이게 있어야 테이블이 나옵니다!)
        function loadRecentReports() {
            fetch('/api/lostandfound/list') 
                .then(response => response.json())
                .then(list => {
                    const tbody = document.getElementById('reportListBody');
                    tbody.innerHTML = ''; 

                    if (list.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td class="px-6 py-10 text-center text-gray-500" colspan="4">
                                    <div class="flex flex-col items-center">
                                        <i data-lucide="inbox" class="w-8 h-8 mb-2 text-gray-300"></i>
                                        신고된 내역이 없습니다.
                                    </div>
                                </td>
                            </tr>`;
                        lucide.createIcons();
                        return;
                    }

                    list.forEach(item => {
                        // 날짜 처리 (null 체크 포함)
                        const date = item.reportDate ? new Date(item.reportDate).toLocaleDateString() : '-';
                        
                        // 분실 유형 한글 변환
                        let typeText = item.lossType;
                        if(item.lossType === 'lost') typeText = '분실';
                        else if(item.lossType === 'damaged') typeText = '파손';
                        else if(item.lossType === 'delay') typeText = '지연';

                        // 상태 배지 색상
                        let statusColor = 'bg-gray-100 text-gray-800'; // 기본
                        if(item.status === '조사중') statusColor = 'bg-yellow-100 text-yellow-800';
                        else if(item.status === '처리완료') statusColor = 'bg-green-100 text-green-800';

                        const row = `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-sm font-medium text-gray-900">${item.postNo}</td>
                                <td class="px-6 py-4 text-sm text-gray-500">${typeText}</td>
                                <td class="px-6 py-4 text-sm text-gray-500">${date}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                        ${item.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                })
                .catch(err => console.error('목록 로드 실패:', err));
        }

        // [기능 3] 신고 접수 (HTML name을 바꿨으므로 JS가 간단해짐)
        document.getElementById('lossForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            // HTML name을 DTO와 똑같이 맞췄기 때문에 별도 매핑 불필요
            const data = Object.fromEntries(formData.entries());
            
            // 상태값 강제 주입
            data.status = '조사중'; 

            fetch('/api/lostandfound/fileReport', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if(response.ok) return response.text();
                throw new Error('서버 응답 오류');
            })
            .then(result => {
                alert('신고가 정상적으로 접수되었습니다.');
                e.target.reset(); 
                loadStatistics();    // 통계 갱신
                loadRecentReports(); // 목록 갱신
            })
            .catch(error => {
                console.error('Error:', error);
                alert('신고 접수 중 오류가 발생했습니다. (송장번호를 확인해주세요)');
            });
        });

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            loadStatistics();
            loadRecentReports();
        });
    </script>
</body>
</html>